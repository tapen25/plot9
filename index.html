<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Beat: Smooth Loop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
body {
    font-family: sans-serif;
    text-align: center;
    background-color: #111;
    color: #eee;
    padding-top: 20px;
    overflow: hidden;
}
#playBtn {
    padding: 15px 30px;
    font-size: 1.2rem;
    background: #00d2ff;
    border: none;
    border-radius: 30px;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    margin-top: 50px;
}
.status-container {
    margin: 20px 0;
}
#bpmDisplay {
    font-size: 3rem;
    font-weight: bold;
    margin: 0;
    color: #00d2ff;
}
#stageDisplay {
    font-size: 1.2rem;
    letter-spacing: 0.2rem;
    text-transform: uppercase;
    color: #888;
}
#fillIndicator {
    height: 30px;
    color: #ff0055;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.1s;
}
#fillIndicator.active {
    opacity: 1;
}

/* Visualizer */
#visual {
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, #444 0%, #111 70%);
    border-radius: 50%;
    margin: 30px auto;
    border: 2px solid #555;
    transition: transform 0.1s;
}

/* Layers UI */
.layer-container {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
}
.layer {
    background: #222;
    border: 1px solid #444;
    padding: 10px;
    border-radius: 8px;
    width: 60px;
    opacity: 0.3;
    transition: opacity 0.3s, background 0.2s;
}
.layer.active {
    opacity: 1;
    background: #333;
    border-color: #00d2ff;
}
.layer-name {
    font-size: 0.7rem;
    display: block;
}
</style>

</head>
<body>

    <div class="status-container">
        <div id="stageDisplay">WAITING...</div>
        <h1 id="bpmDisplay">---</h1>
        <div id="fillIndicator">/// FILL ///</div>
    </div>

    <div id="visual"></div>

    <div class="layer-container">
        <div id="l1" class="layer"><span class="layer-name">KICK</span></div>
        <div id="l2" class="layer"><span class="layer-name">HIHAT</span></div>
        <div id="l3" class="layer"><span class="layer-name">BASS</span></div>
        <div id="l4" class="layer"><span class="layer-name">SNARE</span></div>
    </div>

    <button id="playBtn">TAP TO START</button>

<script>
/* ---------------------------------------
   1. Stage Config (BPM 110〜126)
--------------------------------------- */
const STAGES = {
    LOW:  { name: "WALK", bpm: 110, threshold: 0 },
    MID:  { name: "JOG",  bpm: 118, threshold: 3.8 },
    HIGH: { name: "RUN",  bpm: 126, threshold: 7.2 }
};

let currentStageKey = 'LOW';
let targetStageKey = 'LOW';
let isFilling = false;

let motionBuffer = [];
const BUFFER_SIZE = 50;
let currentEnergy = 0;

/* ---------------------------------------
   2. Motion Logic
--------------------------------------- */
function handleMotion(event) {
    const g = event.accelerationIncludingGravity;
    if (!g) return;

    const mag = Math.sqrt((g.x||0)**2 + (g.y||0)**2 + (g.z||0)**2);
    motionBuffer.push(mag);
    if (motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
}

function computeState() {
    if (motionBuffer.length < BUFFER_SIZE) return;

    const mean = motionBuffer.reduce((a,b)=>a+b,0) / motionBuffer.length;
    const variance = motionBuffer.reduce((a,b)=>a+(b-mean)**2,0) / motionBuffer.length;
    const sd = Math.sqrt(variance);

    let next = 'LOW';
    if (sd > STAGES.HIGH.threshold) next = 'HIGH';
    else if (sd > STAGES.MID.threshold) next = 'MID';

    targetStageKey = next;

    currentEnergy += (Math.min(sd/8, 1) - currentEnergy) * 0.1;
}

function updateVisuals() {
    requestAnimationFrame(updateVisuals);
    computeState();

    document.getElementById("bpmDisplay").innerText = STAGES[currentStageKey].bpm;
    document.getElementById("stageDisplay").innerText = STAGES[currentStageKey].name;

    document.getElementById("fillIndicator").classList.toggle("active", isFilling);

    const scale = 1.0 + currentEnergy * 0.5;
    document.getElementById("visual").style.transform = `scale(${scale})`;

    document.querySelectorAll(".layer").forEach(l => l.classList.add("active"));
}

/* ---------------------------------------
   3. Sequencer (64 steps)
--------------------------------------- */

const STEP_COUNT = 64;  // ← 4 小節分

/* 通常パターン（16stepだが内部で4回繰り返す） */
const BASE_PAT = {
    LOW: {
        kick:  [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0],
        snare: [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
        hihat: [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0],
        bass:  [1,0,0,0, 0,0,1,0, 0,0,0,0, 1,0,0,0]
    },
    MID: {
        kick:  [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,1],
        snare: [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
        hihat: [1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1],
        bass:  [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0]
    },
    HIGH: {
        kick:  [1,0,1,0, 0,0,1,0, 1,0,0,1, 0,0,1,0],
        snare: [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0],
        hihat: [1,1,1,1, 1,1,1,1, 1,1,1,1, 2,1,1,1],
        bass:  [1,0,0,0, 1,0,0,0, 1,1,1,0, 1,0,0,0]
    }
};

/* フィルイン（かなり控えめ） */
const FILL_PAT = {
    kick:  [1,0,0,0],  // 普段通り
    snare: [0,0,0,0],  // ほぼ無し
    hihat: [2,1,2,1],  // 少しオープン
    bass:  [0,0,0,0]   // 無音
};

let kick, snare, hihat, bass;

function expandPattern(p16) {
    const full = [];
    for (let i=0;i<64;i++) full.push(p16[i % 16]);
    return full;
}

function setupAudio() {
    const limiter = new Tone.Limiter(-1).toDestination();

    kick = new Tone.MembraneSynth().connect(limiter);
    snare = new Tone.NoiseSynth({ envelope:{ decay:0.15 }}).connect(limiter);
    hihat = new Tone.NoiseSynth({ envelope:{ decay:0.05 }}).connect(limiter);
    bass = new Tone.MonoSynth().connect(limiter);

    let step = 0;

    Tone.Transport.scheduleRepeat((time)=>{
        const isBlockHead = (step === 0);

        if (isBlockHead) {
            if (isFilling) {
                isFilling = false;
                currentStageKey = targetStageKey;
                Tone.Transport.bpm.value = STAGES[currentStageKey].bpm;
            }
            else if (targetStageKey !== currentStageKey) {
                isFilling = true;
            }
        }

        let pat;
        if (isFilling) {
            pat = {
                kick: expandPattern(FILL_PAT.kick),
                snare: expandPattern(FILL_PAT.snare),
                hihat: expandPattern(FILL_PAT.hihat),
                bass: expandPattern(FILL_PAT.bass)
            };
        } else {
            const base = BASE_PAT[currentStageKey];
            pat = {
                kick: expandPattern(base.kick),
                snare: expandPattern(base.snare),
                hihat: expandPattern(base.hihat),
                bass: expandPattern(base.bass)
            };
        }

        if (pat.kick[step])     kick.triggerAttackRelease("C1","8n",time);
        if (pat.snare[step])    snare.triggerAttackRelease("16n",time);
        if (pat.hihat[step])    hihat.triggerAttackRelease("32n",time, pat.hihat[step]===2 ? 0.5 : 0.2);
        if (pat.bass[step])     bass.triggerAttackRelease("C2","16n",time);

        step = (step+1) % STEP_COUNT;

    }, "16n");
}

/* ---------------------------------------
   Start
--------------------------------------- */
document.getElementById("playBtn").addEventListener("click", async ()=>{
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
        const res = await DeviceMotionEvent.requestPermission();
        if (res !== "granted") alert("Motion permission required!");
    }

    window.addEventListener("devicemotion", handleMotion);

    await Tone.start();
    setupAudio();

    Tone.Transport.bpm.value = STAGES.LOW.bpm;
    Tone.Transport.start();

    updateVisuals();
    document.getElementById("playBtn").style.display = "none";
});
</script>

</body>
</html>
