<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Whiplash Walk Sync</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
    body { background:#111; color:white; font-family:sans-serif; text-align:center; padding-top:40px; }
    button { padding:15px 25px; font-size:18px; border-radius:8px; }
</style>
</head>
<body>

<button id="playBtn">Start / センサー許可</button>

<script>
let motionBuffer = [];
const BUFFER_SIZE = 25;

let currentBPM = 110;
let targetBPM = 110;

function handleMotion(event) {
    const g = event.accelerationIncludingGravity;
    if (!g) return;

    const mag = Math.sqrt((g.x||0)**2 + (g.y||0)**2 + (g.z||0)**2);
    motionBuffer.push(mag);
    if (motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
}

function computeStepPace() {
    if (motionBuffer.length < BUFFER_SIZE) return;

    // -------- 標準偏差 --------
    const mean = motionBuffer.reduce((a,b)=>a+b,0)/motionBuffer.length;
    const variance = motionBuffer.reduce((a,b)=>a+(b-mean)**2,0)/motionBuffer.length;
    const sd = Math.sqrt(variance);

    // ざっくり歩行ペース推定（適当に調整）
    // sd が大きい → 歩きが大きい → BPM 上げる
    let newBPM = 100 + sd * 18; 
    newBPM = Math.max(100, Math.min(130, newBPM));

    targetBPM = newBPM;
}

function smoothBPM() {
    currentBPM += (targetBPM - currentBPM) * 0.05; // ジワジワ変化
    Tone.Transport.bpm.value = currentBPM;
}

let kick, bassSynth, leadSynth;

function setupAudio() {
    // ----- KICK -----
    kick = new Tone.MembraneSynth({
        pitchDecay: 0.02,
        octaves: 4,
        envelope: { attack: 0.001, decay: 0.25, sustain: 0.0, release: 0.05 }
    }).toDestination();

    // ----- ミニマル・ベース -----
    bassSynth = new Tone.FMSynth({
        modulationIndex: 6,
        harmonicity: 1,
        oscillator: { type: "sine" },
        envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }
    });
    const bassFilter = new Tone.Filter(120, "lowpass").toDestination();
    bassSynth.connect(bassFilter);

    // ----- Whiplash風メタリック・リード -----
    leadSynth = new Tone.FMSynth({
        modulationIndex: 15,
        harmonicity: 2,
        oscillator: { type:"square" },
        modulation: { type:"sine" },
        envelope: { attack:0.005, decay:0.15, sustain:0.1, release:0.2 }
    });

    const leadFilter = new Tone.Filter(800, "bandpass");
    const leadDist = new Tone.Distortion(0.25).toDestination();
    leadSynth.chain(leadFilter, leadDist);

    // --------------------------------
    //           PATTERNS
    // --------------------------------

    // Kick (4つ打ち)
    new Tone.Loop(time => {
        kick.triggerAttackRelease("C1", 0.1, time);
    }, "1n").start(0);

    // ベース（ミニマル 2 トーン）
    const bassNotes = ["C2", "D#2"]; // Whiplash の薄暗い感じに寄せる
    let bassIndex = 0;

    new Tone.Loop(time => {
        bassSynth.triggerAttackRelease(bassNotes[bassIndex], 0.2, time);
        bassIndex = (bassIndex + 1) % bassNotes.length;
    }, "2n").start(0);

    // メロディ：Whiplash イントロ風の金属リフ
    const leadPattern = ["G4","A#4","G4","D#4", null, "G4", "A#4", null];
    let leadIndex = 0;

    new Tone.Loop(time => {
        const note = leadPattern[leadIndex];
        if (note) {
            leadSynth.triggerAttackRelease(note, 0.15, time);
        }
        leadIndex = (leadIndex + 1) % leadPattern.length;
    }, "8n").start(0);
}

function update() {
    computeStepPace();
    smoothBPM();
    requestAnimationFrame(update);
}

document.getElementById("playBtn").addEventListener("click", async () => {
    // iOS のセンサー許可
    if (DeviceMotionEvent?.requestPermission) {
        const s = await DeviceMotionEvent.requestPermission();
        if (s !== "granted") return alert("センサー許可が必要です");
    }

    window.addEventListener("devicemotion", handleMotion);

    await Tone.start();
    setupAudio();
    Tone.Transport.start();
    update();

    document.getElementById("playBtn").style.display = "none";
});
</script>

</body>
</html>
