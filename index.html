<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WalkSync Whiplash Style</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
body { background: #111; color: #fff; font-family: sans-serif; text-align:center; padding:40px; }
button { font-size: 20px; padding: 15px 30px; border-radius: 10px; }
</style>
</head>
<body>

<h2>Whiplash Intro × Walk Sync</h2>
<button id="playBtn">Start</button>
<p id="bpmLabel">BPM: --</p>

<script>
// -------------------------
// Motion analysis
// -------------------------
const BUFFER_SIZE = 25;
let motionBuffer = [];

function handleMotion(e){
    const g = e.accelerationIncludingGravity;
    if(!g) return;
    const mag = Math.sqrt((g.x||0)**2 + (g.y||0)**2 + (g.z||0)**2);
    motionBuffer.push(mag);
    if(motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
}

function calcStdDev(arr){
    if(arr.length < 2) return 0;
    const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
    const v = arr.map(x => (x-avg)**2);
    return Math.sqrt(v.reduce((a,b)=>a+b,0) / arr.length);
}

// -------------------------
// AUDIO
// -------------------------
let kick, bass, noise, filter, loop, sweepLoop;

// Whiplash系キック
function createKick(){
    const osc = new Tone.Oscillator("A1").toDestination();
    const env = new Tone.AmplitudeEnvelope({
        attack: 0.001,
        decay: 0.10,
        sustain: 0,
        release: 0.05
    }).toDestination();

    osc.connect(env);
    return {
        trigger: ()=> {
            osc.frequency.setValueAtTime("A1", Tone.now());
            osc.frequency.exponentialRampToValueAtTime("A0", Tone.now()+0.12);
            env.triggerAttackRelease(0.15);
        }
    };
}

// Deep FM bass
function createBass(){
    const bass = new Tone.FMSynth({
        modulationIndex: 2,
        envelope: { attack:0.01, decay:0.2, sustain:0.1, release:0.2 },
        modulationEnvelope: { attack:0.01, decay:0.2, sustain:0.1, release:0.2 }
    }).toDestination();
    return bass;
}

// Noise sweep（Whiplash の息のような音）
function createNoiseSweep(){
    const noise = new Tone.Noise("white");
    const filter = new Tone.Filter(800, "lowpass").toDestination();
    noise.connect(filter);

    return {
        trigger: ()=>{
            noise.start();
            filter.frequency.setValueAtTime(1200, Tone.now());
            filter.frequency.exponentialRampToValueAtTime(200, Tone.now()+0.3);
            setTimeout(()=> noise.stop(), 350);
        }
    }
}

function setupAudio(){
    kick = createKick();
    bass = createBass();
    noise = createNoiseSweep();
}

// -------------------------
// LOOP
// -------------------------
function startLoop(){
    // メインパターン（4拍ループ）
    loop = new Tone.Loop(time=>{
        kick.trigger();

        // 1拍目と3拍目にベース
        const beat = Tone.Transport.position.split(":")[1];
        if(beat == "0" || beat == "2"){
            bass.triggerAttackRelease("E1", "8n", time + 0.05);
        }

        // 2小節ごとに軽いノイズスウィープ
        if(Math.random() < 0.25){
            noise.trigger();
        }
    }, "4n").start(0);

    Tone.Transport.start();
}

// -------------------------
// BPM follow
// -------------------------
let currentBPM = 110;  // 初期
Tone.Transport.bpm.value = currentBPM;

function update(){
    if(motionBuffer.length > 10){
        const std = calcStdDev(motionBuffer); // 揺れの大きさ
        const target = mapStdToBPM(std);

        // ジワジワ寄せる（急に変わらない）
        currentBPM = currentBPM*0.92 + target*0.08;
        Tone.Transport.bpm.rampTo(currentBPM, 0.5);

        document.getElementById("bpmLabel").innerText =
            "BPM: " + currentBPM.toFixed(1);
    }
    requestAnimationFrame(update);
}

function mapStdToBPM(std){
    // 揺れが小さい→100
    // 揺れが大きい→130
    const clamped = Math.min(Math.max(std, 0.05), 0.8);
    return 100 + (clamped-0.05) * (30/(0.75));
}

// -------------------------
// Start
// -------------------------
document.getElementById("playBtn").addEventListener("click", async ()=>{
    if(DeviceMotionEvent?.requestPermission){
        const s = await DeviceMotionEvent.requestPermission();
        if(s !== "granted") return alert("センサー許可が必要です");
    }
    window.addEventListener("devicemotion", handleMotion);

    await Tone.start();
    setupAudio();
    startLoop();

    document.getElementById("playBtn").style.display = "none";
    update();
});
</script>

</body>
</html>
