<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walk DJ Mix (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { background:#111; color:#fff; font-family:sans-serif; padding:20px; text-align:center; touch-action: manipulation; }
        h2 { margin-bottom: 5px; }
        
        #playBtn { padding:15px 40px; font-size:1.2rem; border-radius:30px; border:none; background:#ff0055; color:white; cursor:pointer; font-weight:bold; margin-top: 20px;}
        
        #status { margin-top: 20px; font-size: 2.5rem; font-weight: bold; color: #555; transition: color 0.2s; height: 50px;}
        #subStatus { font-size: 1rem; color: #aaa; height: 20px; margin-bottom: 20px;}
        
        .controls { margin: 20px auto; padding: 15px; background: #222; border-radius: 10px; max-width: 400px; }
        input[type=range] { width: 100%; margin: 10px 0; }
        label { display: block; margin-bottom: 5px; color: #00bfff; }

        .test-btn { background: #333; color: #fff; border: 1px solid #555; padding: 5px 15px; border-radius: 15px; cursor: pointer; margin-top: 10px; font-size: 0.8rem;}
        .test-btn:active { background: #555; }
    </style>
</head>
<body>
    <h2>Walk DJ Mix v2</h2>
    
    <div id="status">STOP</div>
    <div id="subStatus">æ­©ã„ã¦ã¿ã¦ãã ã•ã„</div>

    <div class="controls">
        <label>æ„Ÿåº¦èª¿æ•´ (Sensitivity)</label>
        <input type="range" id="sensRange" min="0.5" max="3.0" step="0.1" value="1.5">
        <div style="font-size:0.8rem; color:#888;">
            å·¦ï¼šå¼·ãæŒ¯ã‚‰ãªã„ã¨é³´ã‚‰ãªã„ <br> å³ï¼šå°‘ã—ã®æºã‚Œã§é³´ã‚‹
        </div>
        <div style="margin-top:15px; border-top:1px solid #444; padding-top:10px;">
            <div id="debug">æºã‚Œ: 0.00</div>
            <button class="test-btn" id="forceMelody">ğŸµ éŸ³å‡ºã—ãƒ†ã‚¹ãƒˆ (æŠ¼ã—ã¦ã„ã‚‹é–“ã ã‘å…¨é–‹)</button>
        </div>
    </div>

    <button id="playBtn">DJ START</button>

    <script>
    // ---------------------------
    // 1. Motion Logic
    // ---------------------------
    const BUFFER_SIZE = 20;
    const motionBuffer = [];
    let smoothedStd = 0;
    let sensitivity = 1.5; // æ„Ÿåº¦å€ç‡

    function handleMotion(event) {
        const g = event.accelerationIncludingGravity;
        if(!g) return;
        const mag = Math.sqrt((g.x||0)**2 + (g.y||0)**2 + (g.z||0)**2);
        motionBuffer.push(mag);
        if (motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
    }

    function calcStd() {
        if (motionBuffer.length === 0) return 0;
        const mean = motionBuffer.reduce((a,b)=>a+b,0) / motionBuffer.length;
        const variance = motionBuffer.reduce((a,b)=>a+(b-mean)**2,0) / motionBuffer.length;
        return Math.sqrt(variance);
    }

    // ---------------------------
    // 2. Tone.js Setup
    // ---------------------------
    let kick, hihat, chordSynth, filter;
    let isPlaying = false;
    let isForced = false; // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ç”¨

    function setupAudio() {
        // ãƒã‚¹ã‚¿ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        filter = new Tone.Filter({
            type: "lowpass",
            frequency: 200, 
            Q: 1
        }).toDestination();

        // 1. Kick (å¸¸æ™‚)
        kick = new Tone.MembraneSynth({
            volume: 0,
        }).connect(filter);

        // 2. Hi-hat
        hihat = new Tone.MetalSynth({
            volume: -60, 
            frequency: 200,
            envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
            harmonicity: 5.1,
            modulationIndex: 32,
            octaves: 1.5
        }).connect(filter);

        // 3. Chord (ãƒ¡ãƒ­ãƒ‡ã‚£) - éŸ³é‡ã‚’ä¸Šã’ã‚„ã™ãèª¿æ•´
        chordSynth = new Tone.PolySynth(Tone.Synth, {
            volume: -60,
            maxPolyphony: 4, // è² è·è»½æ¸›
            oscillator: { type: "sawtooth" }, // ã‚ˆã‚ŠæŠœã‘ã®è‰¯ã„éŸ³ã«å¤‰æ›´
            envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 1 }
        }).connect(filter);
    }

    // ---------------------------
    // 3. Music Loop
    // ---------------------------
    function startLoop() {
        // å°‘ã—æ˜ã‚‹ã‚ã®ã‚³ãƒ¼ãƒ‰é€²è¡Œ (Fmaj7 -> G7 -> Em7 -> Am7)
        const chords = [
            ["F3", "A3", "C4", "E4"], 
            ["G3", "B3", "D4", "F4"],
            ["E3", "G3", "B3", "D4"],
            ["A3", "C4", "E4", "G4"] 
        ];
        let step = 0;

        const loop = new Tone.Loop(time => {
            // Kick (4ã¤æ‰“ã¡)
            kick.triggerAttackRelease("C2", "8n", time);
            
            // Hihat (è£æ‰“ã¡)
            hihat.triggerAttackRelease("32n", time + Tone.Time("8n").toSeconds());

            // Chord (4æ‹ã«1å›ã‚¸ãƒ£ãƒ¼ãƒ³ã¨é³´ã‚‰ã™ï¼åˆ†ã‹ã‚Šã‚„ã™ã)
            if (step % 4 === 0) {
                const currentChord = chords[(step / 4) % 4];
                chordSynth.triggerAttackRelease(currentChord, "2n", time);
            }
            
            step++;
        }, "8n"); // 8åˆ†éŸ³ç¬¦å˜ä½ã§é€²è¡Œ

        Tone.Transport.bpm.value = 124; 
        Tone.Transport.start();
        loop.start(0);
    }

    // ---------------------------
    // 4. Update Logic
    // ---------------------------
    function update() {
        if (!isPlaying) return;
        requestAnimationFrame(update);

        // æ„Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’å–å¾—
        sensitivity = parseFloat(document.getElementById('sensRange').value);

        // æºã‚Œã®è¨ˆç®—
        let rawStd = calcStd();
        
        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ã‚Œã°å¼·åˆ¶çš„ã«MAXã¨ã¿ãªã™
        if (isForced) rawStd = 1.0;

        // æ„Ÿåº¦ã‚’é©ç”¨
        const adjustedStd = rawStd * sensitivity;

        // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
        smoothedStd += (adjustedStd - smoothedStd) * 0.1;

        // è¡¨ç¤ºæ›´æ–°
        document.getElementById('debug').innerText = "æºã‚Œ: " + smoothedStd.toFixed(2) + " (æ„Ÿåº¦: x" + sensitivity + ")";
        const statusEl = document.getElementById('status');
        const subStatusEl = document.getElementById('subStatus');

        // --- MIXING LOGIC (ã—ãã„å€¤ã‚’ç·©å’Œ) ---
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯å¸¸ã«æºã‚Œã«é€£å‹• (0.1ã‹ã‚‰åå¿œé–‹å§‹)
        const freq = mapRange(smoothedStd, 0.1, 1.0, 300, 15000);
        filter.frequency.rampTo(Math.max(300, Math.min(15000, freq)), 0.1);

        // éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        if (smoothedStd < 0.2) {
            // Level 0: ã»ã¼åœæ­¢
            statusEl.innerText = "STOP";
            statusEl.style.color = "#555";
            subStatusEl.innerText = "ã‚­ãƒƒã‚¯ã®ã¿";

            hihat.volume.rampTo(-60, 0.2);
            chordSynth.volume.rampTo(-60, 0.2);

        } else if (smoothedStd < 0.5) {
            // Level 1: æ­©ã (å°‘ã—ãƒ¡ãƒ­ãƒ‡ã‚£ã‚‚æ··ãœã‚‹ï¼)
            statusEl.innerText = "WALK";
            statusEl.style.color = "#00bfff";
            subStatusEl.innerText = "+ãƒã‚¤ãƒãƒƒãƒˆ & ã†ã£ã™ã‚‰ãƒ¡ãƒ­ãƒ‡ã‚£";

            hihat.volume.rampTo(-10, 0.2); 
            // â˜…å¤‰æ›´ç‚¹: ã“ã“ã§å°‘ã—ãƒ¡ãƒ­ãƒ‡ã‚£ã‚’å…¥ã‚Œã‚‹ (-20dbãã‚‰ã„)
            chordSynth.volume.rampTo(-20, 0.2);

        } else {
            // Level 2: å…ƒæ°—ã‚ˆãæ­©ã (å…¨é–‹)
            statusEl.innerText = "RUN!!";
            statusEl.style.color = "#ff0055";
            subStatusEl.innerText = "ãƒ•ãƒ«ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼";

            hihat.volume.rampTo(-10, 0.2);
            chordSynth.volume.rampTo(-8, 0.2); // ãƒ¡ã‚¤ãƒ³éŸ³é‡
        }
    }

    function mapRange(value, inMin, inMax, outMin, outMax) {
        return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
    }

    // ---------------------------
    // 5. Events
    // ---------------------------
    
    // éŸ³å‡ºã—ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
    const testBtn = document.getElementById('forceMelody');
    testBtn.addEventListener('mousedown', () => isForced = true);
    testBtn.addEventListener('mouseup', () => isForced = false);
    testBtn.addEventListener('touchstart', (e) => { e.preventDefault(); isForced = true; });
    testBtn.addEventListener('touchend', (e) => { e.preventDefault(); isForced = false; });

    document.getElementById('playBtn').addEventListener('click', async ()=>{
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const p = await DeviceMotionEvent.requestPermission();
                if (p !== 'granted') alert("ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã§ã™");
            } catch (e) {}
        }
        window.addEventListener('devicemotion', handleMotion);
        
        await Tone.start();
        setupAudio();
        startLoop();
        
        isPlaying = true;
        document.getElementById('playBtn').style.display = 'none';
        update();
    });
    </script>
</body>
</html>