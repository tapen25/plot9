<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Nature to Speed (Step Vibration Stage)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
    body { margin: 0; overflow: hidden; font-family: 'Helvetica Neue', sans-serif; background:#111; color:#fff; user-select:none; -webkit-user-select:none; }
    #bg-layer {
        position:absolute;top:0;left:0;width:100%;height:100%;
        background:linear-gradient(to bottom,var(--bg-top,#1a237e),var(--bg-bot,#000));
        transition:background 1.5s ease; z-index:-1;
    }
    .hud { position:absolute;top:0;left:0;width:100%;padding:20px;box-sizing:border-box;text-align:center;pointer-events:none;z-index:10; }
    .stage-indicator { font-size:3rem;font-weight:900;letter-spacing:2px;text-shadow:0 0 10px rgba(255,255,255,0.5);margin-bottom:10px;transition:color 0.5s; }
    .info-row { font-size:1rem;font-family:monospace;opacity:0.8;margin-bottom:5px; }
    .bar-container { width:80%;margin:0 auto;height:10px;background:rgba(255,255,255,0.2);border-radius:5px;overflow:hidden;margin-top:10px; }
    .bar-fill { height:100%;width:0%;background:#00e676;transition:width 0.1s linear,background 0.5s; }
    #startOverlay { position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:50;display:flex;flex-direction:column;justify-content:center;align-items:center; }
    #playBtn { padding:20px 40px;font-size:1.5rem;background:#fff;color:#000;border:none;border-radius:50px;cursor:pointer;font-weight:bold; }
</style>
</head>
<body>

<div id="bg-layer"></div>

<div class="hud">
    <div class="stage-indicator" id="stageText">STAGE 1</div>
    <div class="info-row">BPM: <span id="bpmVal">80</span> | ShakeCount: <span id="shakeVal">0</span></div>
    <div class="bar-container"><div id="progFill" class="bar-fill"></div></div>
</div>

<div id="startOverlay">
    <button id="playBtn">START EXPERIENCE</button>
    <p style="margin-top:20px;color:#ccc;font-size:0.9rem;">(Allow Sensor Permissions)</p>
</div>

<script>
// =====================
// ステージ条件: 15回ごと振動で進む
// =====================
let isPlaying = false;
let currentStage = 1;
let shakeCount = 0; 
let vibrationCount = 0;
let lastWasPeak = false;

const PEAK_THRESHOLD = 0.18;
const chordLibrary = {
    "DM7":["D3","F#3","A3","C#4"],"Bm7":["B2","D3","F#3","A3"],
    "Em7":["E3","G3","B3","D4"],"A7":["A2","C#3","E3","G3"],
    "GM7":["G3","B3","D4","F#4"],"F#m7":["F#3","A3","C#4","E4"],
    "BbM7":["Bb2","D3","F3","A3"],"EbM7":["Eb3","G3","Bb3","D4"]
};
const arpPattern = [0,1,2,3,2,1];

let synthLead, synthChord, synthBass, drumKick, drumSnare, drumHat;

function setupAudio() {
    const mainVol=new Tone.Volume(-2).toDestination();
    const limiter=new Tone.Limiter(-0.5).connect(mainVol);
    const rev=new Tone.Reverb({decay:2.5,wet:0.3}).connect(limiter);

    synthLead=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"triangle"},envelope:{attack:0.01,decay:0.1,sustain:0.1,release:1},volume:-5}).connect(rev);
    synthChord=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sine"},envelope:{attack:0.1,decay:0.3,sustain:0.5,release:1.5},volume:-8}).connect(rev);
    synthBass=new Tone.FMSynth({harmonicity:1.5,modulationIndex:5,envelope:{attack:0.01,decay:0.2,sustain:0.4,release:0.2},volume:-2}).connect(limiter);
    drumKick=new Tone.MembraneSynth({volume:0}).connect(limiter);
    drumSnare=new Tone.NoiseSynth({noise:{type:"white"},envelope:{attack:0.001,decay:0.15,sustain:0},volume:-8}).connect(rev);
    drumHat=new Tone.MetalSynth({frequency:200,envelope:{attack:0.001,decay:0.05,release:0.01},harmonicity:5.1,modulationIndex:32,resonance:4000,octaves:1.5,volume:-15}).connect(limiter);
}

let tick=0;
const prog1=["DM7","Bm7","Em7","A7"];
const prog2=["GM7","A7","F#m7","Bm7"];
const prog3=["Em7","EbM7","DM7","GM7"];

function startLoop() {
    Tone.Transport.bpm.value = 80;
    Tone.Transport.scheduleRepeat((time)=>{
        let prog=currentStage===1?prog1:currentStage===2?prog2:prog3;
        const beat16=tick%16;
        const barIdx=Math.floor(tick/16)%prog.length;
        const cName=prog[barIdx];
        const notes=chordLibrary[cName]||["D3","A3","F#3","C#4"];

        if(beat16===0){synthChord.triggerAttackRelease(notes,"1n",time);synthBass.triggerAttackRelease(notes[0],"4n",time);}
        if((currentStage>=2||smoothedActivity>0.3)&&(beat16===4||beat16===12)){drumSnare.triggerAttackRelease("8n",time);}
        if(beat16%4===0){drumKick.triggerAttackRelease("C1","8n",time,0.7);}
        if(smoothedActivity>0.2&&beat16%2===0){drumHat.triggerAttackRelease("32n",time,0.5);}
        if(smoothedActivity>0.1){playArp(time,notes,beat16);}

        tick++;
    },"16n");
    Tone.Transport.start();
}

function playArp(time,notes){if(tick%2===0){let step=Math.floor(tick/2)%arpPattern.length;let i=arpPattern[step]%notes.length;let oct=Math.random()>0.5?4:5;let n=notes[i].replace(/\d/,oct);synthLead.triggerAttackRelease(n,"16n",time);}}

let smoothedActivity=0;
function handleMotion(e){let g=e.accelerationIncludingGravity;if(!g)return;let mag=Math.sqrt((g.x||0)**2+(g.y||0)**2+(g.z||0)**2);let sd=Math.abs(mag-9.81)/9.81;let act=Math.min(sd,1);smoothedActivity+=(act-smoothedActivity)*0.15;}

function detectVibration() {
    const isPeak = (smoothedActivity > PEAK_THRESHOLD);

    if (isPeak && !lastWasPeak) {
        vibrationCount++;
        if (vibrationCount > 3) {
            shakeCount++;
            vibrationCount = 0;
            vibrationCount > 3 && (currentStage=2)
            // ステージアップ処理（15回区切り）
            if(!isPlaying) return;
            if(shakeCount === 15 && currentStage === 1) {
                currentStage = 2;
            }
            if(shakeCount === 30 && currentStage === 2) {
                currentStage = 3;
            }
        }
    }
    lastWasPeak = isPeak;
}

function update() {
    requestAnimationFrame(update);
    if(!isPlaying) return;

    detectVibration();
    const bpmTarget = 40 + smoothedActivity * 120;
    Tone.Transport.bpm.rampTo(bpmTarget, 0.2);

    updateUI();
}

function updateUI() {
    const t=document.getElementById("stageText");
    const bar=document.getElementById("progFill");
    document.getElementById("bpmVal").innerText=Math.round(Tone.Transport.bpm.value);
    document.getElementById("shakeVal").innerText=shakeCount;

    let pct=0;
    if(currentStage===1){t.innerText="STAGE 1: DAWN";t.style.color="#82b1ff";pct=(shakeCount/15)*100;bar.style.background="#82b1ff";}
    if(currentStage===2){t.innerText="STAGE 2: SUN";t.style.color="#ffea00";pct=((shakeCount-15)/15)*100;bar.style.background="#ffea00";}
    if(currentStage===3){t.innerText="STAGE 3: BLAZE";t.style.color="#ff3d00";pct=100;bar.style.background="#ff3d00";}
    bar.style.width=Math.min(100,Math.max(0,pct))+"%";
}

document.getElementById("playBtn").addEventListener("click",async()=>{
    if(DeviceMotionEvent&&DeviceMotionEvent.requestPermission){try{let s=await DeviceMotionEvent.requestPermission();if(s!=='granted')alert("Sensor not allowed");}catch(e){}}
    window.addEventListener("devicemotion",handleMotion);
    await Tone.start();
    setupAudio();
    startLoop();
    isPlaying=true;
    document.getElementById("startOverlay").style.display="none";
    update();
});
</script>
</body>
</html>
