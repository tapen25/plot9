<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Beat: Layers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>
    
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            padding-top: 40px;
            /* スクロール防止（誤操作防止） */
            touch-action: none; 
            background-color: #f0f0f0;
            transition: background-color 0.5s;
        }
        #playBtn {
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .layer-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .layer {
            opacity: 0.3;
            transition: opacity 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .layer-box {
            width: 50px;
            height: 50px;
            background: #333;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        .layer.active {
            opacity: 1;
        }
        .layer.active .layer-box {
            background: #ff5500;
            box-shadow: 0 0 10px #ff5500;
        }
        #visual {
            width: 100px;
            height: 100px;
            background-color: #333;
            border-radius: 50%;
            margin: 20px auto;
            transition: transform 0.1s;
        }
    </style>
</head>
<body>

    <div id="info">
        <div>BPM</div>
        <h1 id="bpmDisplay">---</h1>
        <p style="font-size:0.8rem; color:#666;">Shake your device to add layers!</p>
    </div>

    <div id="visual"></div>

    <div class="layer-container">
        <div id="l1" class="layer">
            <div class="layer-box"></div>
            <span class="layer-name">KICK</span>
        </div>
        <div id="l2" class="layer">
            <div class="layer-box"></div>
            <span class="layer-name">SNARE</span>
        </div>
        <div id="l3" class="layer">
            <div class="layer-box"></div>
            <span class="layer-name">BASS</span>
        </div>
        <div id="l4" class="layer">
            <div class="layer-box"></div>
            <span class="layer-name">HIHAT</span>
        </div>
    </div>

    <br><br>
    <button id="playBtn">TAP TO START</button>

<script>
    // --- NoSleep Setup ---
    // 画面が消えないようにするためのインスタンスを作成
    const noSleep = new NoSleep();

    // --- Motion Logic ---
    let motionBuffer = [];
    const BUFFER_SIZE = 40; 
    let currentBPM = 100;
    let targetBPM = 100;
    let currentEnergy = 0; 
    let targetEnergy = 0;

    function handleMotion(event) {
        const g = event.accelerationIncludingGravity;
        if (!g) return;
        
        const mag = Math.sqrt((g.x||0)**2 + (g.y||0)**2 + (g.z||0)**2);
        motionBuffer.push(mag);
        if (motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
    }

    function computeState() {
        if (motionBuffer.length < BUFFER_SIZE) return;

        const mean = motionBuffer.reduce((a,b)=>a+b,0) / motionBuffer.length;
        const variance = motionBuffer.reduce((a,b)=>a+(b-mean)**2,0) / motionBuffer.length;
        const sd = Math.sqrt(variance);

        let bpmSet = 110;
        if (sd < 1.5) bpmSet = 110;
        else if (sd < 3.0) bpmSet = 114;
        else if (sd < 4.5) bpmSet = 120;
        else if (sd < 6.0) bpmSet = 126;
        else bpmSet = 130;

        targetBPM = bpmSet;
        targetEnergy = Math.min(sd / 6.0, 1.0);
    }

    function updateVisuals() {
        requestAnimationFrame(updateVisuals);
        computeState();

        currentBPM += (targetBPM - currentBPM) * 0.01;
        Tone.Transport.bpm.value = currentBPM;
        currentEnergy += (targetEnergy - currentEnergy) * 0.008;

        document.getElementById("bpmDisplay").innerText = currentBPM.toFixed(0);
        
        const scale = 0.8 + currentEnergy * 1.5;
        document.getElementById("visual").style.transform = `scale(${scale})`;

        const layers = [
            document.getElementById("l1"),
            document.getElementById("l2"),
            document.getElementById("l3"),
            document.getElementById("l4") 
        ];
        
        const thresholds = [0.05, 0.3, 0.6, 0.8];
        
        layers.forEach((el, i) => {
            if (currentEnergy > thresholds[i]) el.classList.add("active");
            else el.classList.remove("active");
        });
    }

    // --- Sound Design ---
    let kick, bass, snare, hihat;
    let volKick, volBass, volSnare, volHihat;

    function setupAudio() {
        const masterLimiter = new Tone.Limiter(-2).toDestination();

        // 1. KICK
        kick = new Tone.MembraneSynth({
            pitchDecay: 0.05,
            octaves: 6,
            oscillator: { type: "sine" },
            envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        }).connect(masterLimiter);
        volKick = new Tone.Volume(-60).connect(masterLimiter);
        kick.disconnect(); kick.connect(volKick);

        // 2. HIHAT
        hihat = new Tone.NoiseSynth({
            noise: { type: "white" },
            envelope: { attack: 0.001, decay: 0.1, sustain: 0 }
        });
        const hhFilter = new Tone.Filter(8000, "highpass").connect(masterLimiter);
        volHihat = new Tone.Volume(-60).connect(hhFilter);
        hihat.disconnect(); hihat.connect(volHihat);

        // 3. BASS
        bass = new Tone.MonoSynth({
            oscillator: { type: "sawtooth" },
            filter: { Q: 2, type: "lowpass", rollover: -12 },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.4, release: 0.4 },
            filterEnvelope: { attack: 0.01, decay: 0.2, baseFrequency: 100, octaves: 3, exponent: 2 }
        }).connect(masterLimiter);
        volBass = new Tone.Volume(-60).connect(masterLimiter);
        bass.disconnect(); bass.connect(volBass);

        // 4. SNARE
        snare = new Tone.NoiseSynth({
            noise: { type: "pink" },
            envelope: { attack: 0.001, decay: 0.25, sustain: 0 }
        });
        const snareTone = new Tone.Oscillator({
            frequency: 200, type: "triangle",
        }).start();
        const snareEnv = new Tone.AmplitudeEnvelope({
            attack: 0.001, decay: 0.1, sustain: 0
        }).connect(masterLimiter);
        snareTone.connect(snareEnv);

        volSnare = new Tone.Volume(-60).connect(masterLimiter);
        snare.disconnect(); snare.connect(volSnare);
        snareEnv.disconnect(); snareEnv.connect(volSnare);

        // --- Sequencer Loop ---
        let step = 0;
        
        Tone.Transport.scheduleRepeat((time) => {
            const fadeInTime = 0.1;
            const fadeOutTime = 0.5;

            // Volume Logic
            if (currentEnergy > 0.05) volKick.volume.rampTo(0, fadeInTime);
            else volKick.volume.rampTo(-60, fadeOutTime);

            if (currentEnergy > 0.3) volSnare.volume.rampTo(-5, fadeInTime);
            else volSnare.volume.rampTo(-60, fadeOutTime);

            if (currentEnergy > 0.6) volBass.volume.rampTo(-4, fadeInTime);
            else volBass.volume.rampTo(-60, fadeOutTime);

            if (currentEnergy > 0.8) volHihat.volume.rampTo(-10, fadeInTime);
            else volHihat.volume.rampTo(-60, fadeOutTime);
            
            // Patterns
            if (step % 4 === 0) kick.triggerAttackRelease("C1", "8n", time);

            if (step % 2 === 0) {
                if (step % 4 === 2) {
                    hihat.envelope.decay = 0.3; 
                    hihat.triggerAttackRelease("32n", time, 0.8);
                } else {
                    hihat.envelope.decay = 0.05; 
                    hihat.triggerAttackRelease("32n", time, 0.3);
                }
            }

            const bassNotes = { 0: "C2", 3: "C2", 7: "Eb2", 10: "G2", 14: "Bb1" };
            if (bassNotes[step]) bass.triggerAttackRelease(bassNotes[step], "16n", time);

            if (step === 4 || step === 12) {
                snare.triggerAttackRelease("16n", time); 
                snareEnv.triggerAttackRelease("16n", time); 
            }

            step = (step + 1) % 16;
        }, "16n");
    }

    document.getElementById("playBtn").addEventListener("click", async () => {
        // --- 修正箇所: NoSleepの有効化 ---
        // ユーザーインタラクション（クリック）の中で呼ぶ必要があります
        try {
            await noSleep.enable();
            console.log("Wake Lock enabled (Screen will stay on)");
        } catch (err) {
            console.error("Wake Lock failed:", err);
        }

        // iOS Motion Permission
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const response = await DeviceMotionEvent.requestPermission();
                if (response !== 'granted') alert("Motion permission required!");
            } catch (e) { console.error(e); }
        }
        
        window.addEventListener("devicemotion", handleMotion);
        
        await Tone.start();
        setupAudio();
        Tone.Transport.start();
        updateVisuals();
        
        const btn = document.getElementById("playBtn");
        btn.innerText = "PLAYING...";
        btn.style.opacity = 0.5;
        // ボタンを消さずに残しておいても良い（リロード用など）ですが、
        // 誤操作防止のため無効化的な見た目にしています
    });
</script>
</body>
</html>