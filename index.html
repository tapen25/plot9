<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StdDev Hardbass</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background: #000; color: #fff;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; height: 100vh;
            font-family: sans-serif;
        }
        #playBtn {
            padding: 20px 40px; font-size: 1.2rem; cursor: pointer;
            background: #ff3333; color: white; border: none; border-radius: 8px;
        }
        #debug { margin-top: 20px; font-family: monospace; color: #aaa; }
    </style>
</head>
<body>

<button id="playBtn">START SENSOR & AUDIO</button>
<div id="debug">Waiting for start...</div>

<script>
    // --- ユーザー提示のコードロジック ---
    let isPlaying = false;
    let smoothedActivity = 0.0; // 徐々に変化する値 (0.0 - 1.0)

    // 30サンプル（約0.5秒分）で標準偏差を取る
    const BUFFER_SIZE = 30;
    const motionBuffer = [];

    // 6. Activity（標準偏差）計算
    function calculateStdDev(arr) {
        if(!arr.length) return 0;
        const m = arr.reduce((a,b)=>a+b,0)/arr.length;
        const v = arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length;
        return Math.sqrt(v);
    }

    // 7. センサー入力
    function handleMotion(event) {
        const g = event.accelerationIncludingGravity;
        if(!g) return;
        // ベクトル長（重力込みの大きさ）
        const mag = Math.sqrt((g.x||0)**2 + (g.y||0)**2 + (g.z||0)**2);
        
        motionBuffer.push(mag);
        if(motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
    }

    // --- Tone.js 音響設定 ---
    let lowPass, kick, bass, hihat;

    function setupAudio() {
        // マスターフィルター（これが変化する）
        lowPass = new Tone.Filter(200, "lowpass").toDestination();

        // (A) キック
        kick = new Tone.MembraneSynth({
            pitchDecay: 0.05, octaves: 10, oscillator: { type: "sine" },
            envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        }).connect(lowPass);

        // (B) ドンクベース (Hardbass sound)
        bass = new Tone.FMSynth({
            harmonicity: 3, modulationIndex: 10, detune: 0,
            oscillator: { type: "sine" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 },
            modulation: { type: "square" },
            modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.03, release: 0.5 }
        }).connect(lowPass);

        // (C) ハイハット
        hihat = new Tone.MetalSynth({
            frequency: 200, envelope: { attack: 0.001, decay: 0.05, release: 0.05 },
            harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5
        }).connect(lowPass);

        // BPM設定
        Tone.Transport.bpm.value = 160;
    }

    function startLoop() {
        // ループ再生
        new Tone.Loop(time => {
            // 4つ打ちキック
            kick.triggerAttackRelease("C1", "8n", time);
            kick.triggerAttackRelease("C1", "8n", time + Tone.Time("4n"));
            kick.triggerAttackRelease("C1", "8n", time + Tone.Time("2n"));
            kick.triggerAttackRelease("C1", "8n", time + Tone.Time("2n") + Tone.Time("4n"));

            // 裏打ちベース
            bass.triggerAttackRelease("C2", "8n", time + Tone.Time("8n"));
            bass.triggerAttackRelease("C2", "8n", time + Tone.Time("4n") + Tone.Time("8n"));
            bass.triggerAttackRelease("C2", "8n", time + Tone.Time("2n") + Tone.Time("8n"));
            bass.triggerAttackRelease("C2", "8n", time + Tone.Time("2n") + Tone.Time("4n") + Tone.Time("8n"));

            // ハイハット (常に刻む)
            hihat.triggerAttackRelease(32, time + Tone.Time("8n"), 0.1); 
            hihat.triggerAttackRelease(32, time + Tone.Time("4n") + Tone.Time("8n"), 0.1); 
            hihat.triggerAttackRelease(32, time + Tone.Time("2n") + Tone.Time("8n"), 0.1); 
            hihat.triggerAttackRelease(32, time + Tone.Time("2n") + Tone.Time("4n") + Tone.Time("8n"), 0.1); 

        }, "1m").start(0);

        Tone.Transport.start();
    }

    // --- メインループ (Visualなし・計算と音制御のみ) ---
    function update() {
        if(!isPlaying) return;

        // 1. 標準偏差の計算（現在の動きの激しさ）
        const stdDev = calculateStdDev(motionBuffer);

        // 2. 正規化（Normalization）
        // stdDevは静止時=0.01程度、激しい時=5.0〜10.0くらいになる想定
        // 8.0あたりをMAXとして 0.0〜1.0 に丸める
        let targetActivity = Math.min(stdDev / 8.0, 1.0);

        // 3. 平滑化（Smoothing）先生のアドバイス対応
        // 現在値に目標値の5%ずつ近づく（ゆっくり変化）
        smoothedActivity += (targetActivity - smoothedActivity) * 0.05;

        // 4. 音響パラメータへの適用
        // フィルター周波数: 200Hz(こもる) 〜 5000Hz(激しい)
        // 指数関数的にマッピング（聴覚上自然にするため）
        const freq = 200 * Math.pow(25, smoothedActivity); 
        
        if(lowPass) {
            lowPass.frequency.rampTo(freq, 0.1);
        }

        // デバッグ表示（数値確認用）
        document.getElementById('debug').innerText = 
            `StdDev: ${stdDev.toFixed(2)}\nActivity: ${(smoothedActivity*100).toFixed(0)}%`;

        requestAnimationFrame(update);
    }

    // --- イベントリスナー ---
    document.getElementById('playBtn').addEventListener('click', async () => {
        // iOSセンサー許可リクエスト
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const s = await DeviceMotionEvent.requestPermission();
                if(s !== 'granted') return alert("センサー許可が必要です");
            } catch(e) {
                console.error(e);
            }
        }

        window.addEventListener('devicemotion', handleMotion);
        
        await Tone.start();
        setupAudio();
        startLoop();
        
        isPlaying = true;
        document.getElementById('playBtn').style.display = 'none';
        
        update(); // ループ開始
    });

</script>

</body>
</html>