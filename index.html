<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walk Reactive Beat (Filter)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { background:#111; color:#fff; font-family:sans-serif; padding:20px; text-align:center; }
        h2 { margin-bottom: 10px; }
        #playBtn { padding:15px 40px; font-size:1.2rem; border-radius:30px; border:none; background:#007bff; color:white; cursor:pointer; }
        #debug { margin-top: 20px; font-size: 1.2rem; color: #0f0; }
        .description { font-size: 0.9rem; color: #ccc; margin-bottom: 20px; line-height: 1.6; }
    </style>
</head>
<body>
    <h2>Walk Reactive Beat</h2>
    <p class="description">
        歩くと音がクリアになり、<br>
        止まると音がこもります。
    </p>
    
    <div id="debug">Sensor: 0.00</div>
    <br>
    <button id="playBtn">Start</button>

    <script>
    // ---------------------------
    // 1. Motion Buffer (動きの検知)
    // ---------------------------
    const BUFFER_SIZE = 20;
    const motionBuffer = [];
    let currentStd = 0;       // 現在の動きの激しさ
    let smoothedStd = 0;      // 滑らかにした値

    function handleMotion(event) {
        // 重力込みの加速度
        const g = event.accelerationIncludingGravity;
        if(!g) return;

        // 3軸の合成ベクトル
        const mag = Math.sqrt((g.x||0)**2 + (g.y||0)**2 + (g.z||0)**2);
        
        motionBuffer.push(mag);
        if (motionBuffer.length > BUFFER_SIZE) motionBuffer.shift();
    }

    // 標準偏差（揺れの大きさ）を計算
    function calcStd() {
        if (motionBuffer.length === 0) return 0;
        const mean = motionBuffer.reduce((a,b)=>a+b,0) / motionBuffer.length;
        const variance = motionBuffer.reduce((a,b)=>a+(b-mean)**2,0) / motionBuffer.length;
        return Math.sqrt(variance);
    }

    // ---------------------------
    // 2. Tone.js Setup
    // ---------------------------
    let kick, hihat, filter, isPlaying=false;

    function setupAudio() {
        // ★ 変更点: Panner3Dの代わりにFilterを使用
        // frequency: 初期値は低く（こもった状態）にしておく
        filter = new Tone.Filter({
            type: "lowpass",
            frequency: 200, 
            Q: 1 // レゾナンス
        }).toDestination();

        // Kick (重低音) -> Filterへ接続
        kick = new Tone.MembraneSynth({
            volume: 0,
            octaves: 4,
            envelope: { attack: 0.001, decay: 0.4, sustain: 0 }
        }).connect(filter);

        // Hi-hat (高音) -> Filterへ接続
        hihat = new Tone.MetalSynth({
            volume: -10,
            frequency: 200,
            envelope: { attack: 0.001, decay: 0.1, release: 0.01 },
            harmonicity: 5.1,
            modulationIndex: 32,
            resonance: 4000,
            octaves: 1.5
        }).connect(filter);
    }

    // ---------------------------
    // 3. Music Loop
    // ---------------------------
    function startLoop() {
        const loop = new Tone.Loop(time => {
            // ドン（表）
            kick.triggerAttackRelease("C2", "8n", time);
            
            // チッ（裏）
            hihat.triggerAttackRelease("32n", time + Tone.Time("8n").toSeconds());
        }, "4n");

        Tone.Transport.bpm.value = 110; 
        Tone.Transport.start();
        loop.start(0);
    }

    // ---------------------------
    // 4. Animation Loop (音の変化を担当)
    // ---------------------------
    function update() {
        if (!isPlaying) return;
        requestAnimationFrame(update);

        // センサー値の計算
        currentStd = calcStd();
        // スムージング（急激な変化を防ぐ）
        smoothedStd += (currentStd - smoothedStd) * 0.1;

        // デバッグ表示
        document.getElementById('debug').innerText = "Sensor: " + smoothedStd.toFixed(3);

        // --- インタラクション判定 ---
        const WALK_THRESHOLD = 0.5; // 歩行判定のしきい値

        // ★ 変更点: 3D回転をやめ、フィルターの開閉を行う
        let targetFreq;
        
        if (smoothedStd > WALK_THRESHOLD) {
            // 歩いている時：フィルターを全開にする（音がクリアに）
            targetFreq = 20000; 
        } else {
            // 止まっている時：フィルターを閉じる（音がこもる）
            // 完全に消音せず、低音だけ残すとかっこいい
            targetFreq = 300; 
        }

        // 滑らかに周波数を変化させる (0.2秒かけて変化)
        // rampToを使うとプチノイズを防げる
        filter.frequency.rampTo(targetFreq, 0.2);
    }

    // ---------------------------
    // 5. Start Button & Permission
    // ---------------------------
    document.getElementById('playBtn').addEventListener('click', async ()=>{
        // iOS センサー許可
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const permission = await DeviceMotionEvent.requestPermission();
                if (permission !== 'granted') {
                    alert("センサー許可が必要です");
                    return;
                }
            } catch (e) { console.error(e); }
        }

        window.addEventListener('devicemotion', handleMotion);
        await Tone.start();
        
        setupAudio();
        startLoop();

        isPlaying = true;
        document.getElementById('playBtn').style.display = 'none';
        
        update();
    });
    </script>
</body>
</html>